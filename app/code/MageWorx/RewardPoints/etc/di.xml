<?xml version="1.0"?>
<!--
/**
 * Copyright Â© MageWorx. All rights reserved.
 * See LICENSE.txt for license details.
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">

    <preference for="MageWorx\RewardPoints\Api\RuleRepositoryInterface"
                type="MageWorx\RewardPoints\Model\RuleRepository" />
    <preference for="MageWorx\RewardPoints\Api\Data\RuleInterface"
                type="MageWorx\RewardPoints\Model\Data\Rule" />
    <preference for="MageWorx\RewardPoints\Api\Data\RuleSearchResultInterface"
                type="Magento\Framework\Api\SearchResults" />
    <preference for="MageWorx\RewardPoints\Api\Data\RuleLabelInterface"
                type="MageWorx\RewardPoints\Model\Data\RuleLabel" />
    <preference for="MageWorx\RewardPoints\Model\Rule\CalculatorInterface"
                type="MageWorx\RewardPoints\Model\Rule\Calculator" />
    <preference for="MageWorx\RewardPoints\Api\Data\CustomerBalanceInterface"
                type="MageWorx\RewardPoints\Model\CustomerBalance" />
    <preference for="MageWorx\RewardPoints\Api\CustomerBalanceRepositoryInterface"
                type="MageWorx\RewardPoints\Model\CustomerBalanceRepository" />
    <preference for="MageWorx\RewardPoints\Api\Data\PointTransactionInterface"
                type="MageWorx\RewardPoints\Model\PointTransaction" />
    <preference for="MageWorx\RewardPoints\Api\PointTransactionRepositoryInterface"
                type="MageWorx\RewardPoints\Model\PointTransactionRepository" />
    <preference for="MageWorx\RewardPoints\Api\RewardManagerInterface"
                type="MageWorx\RewardPoints\Model\RewardManager" />
    <preference for="MageWorx\RewardPoints\Api\Data\RewardPromiseInterface"
                type="MageWorx\RewardPoints\Model\RewardPromise" />
    <preference for="MageWorx\RewardPoints\Api\RewardPromiseManagerInterface"
                type="MageWorx\RewardPoints\Model\RewardPromiseManager" />
    <preference for="MageWorx\RewardPoints\Api\GuestRewardPromiseManagerInterface"
                type="MageWorx\RewardPoints\Model\GuestRewardPromiseManager" />

    <!-- API Support (Plugins) -->
    <type name="Magento\Sales\Api\OrderRepositoryInterface">
        <plugin name="mageworx_add_rewardpoints_to_order" type="MageWorx\RewardPoints\Model\Plugin\Api\AddRewardDataToOrder"/>
    </type>
    <!-- //API Support (Plugins) -->

    <type name="MageWorx\RewardPoints\Model\Rule\Customer">
        <arguments>
            <argument name="resource" xsi:type="object">MageWorx\RewardPoints\Model\ResourceModel\Rule\Customer</argument>
        </arguments>
    </type>

    <!-- Factories -->
    <type name="MageWorx\RewardPoints\Model\EventStrategyFactory">
        <arguments>
            <argument name="map" xsi:type="array">
                <!-- You can add new or replace the default EventStrategy class here. See EventStrategyFactory. For example: -->
                <!--<item name="newsletter_subscription" xsi:type="string">MageWorx\RewardPointsCustom\Model\EventStrategy\CustomNewsletter</item>-->
            </argument>
        </arguments>
    </type>

    <type name="MageWorx\RewardPoints\Model\Rule\CalculationStrategyFactory">
        <arguments>
            <!-- item name is $rule->getCalculationType() . '_' . $rule->getSimpleAction() -->
            <argument name="map" xsi:type="array">
                <item name="fixed_by_fixed_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\FixedByFixedStrategy</item>
                <item name="fixed_spend_y_get_x_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\FixedBySpendAndGetStrategy</item>
                <item name="fixed_spend_y_more_than_z_get_x_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\FixedBySpendAndGetStrategy</item>
                <item name="fixed_buy_y_get_x_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\FixedByBuyAndGetStrategy</item>
                <item name="fixed_buy_y_more_than_z_get_x_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\FixedByBuyAndGetStrategy</item>
                <item name="percent_by_fixed_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\PercentByFixedStrategy</item>
                <item name="percent_spend_y_get_x_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\PercentBySpendAndGetStrategy</item>
                <item name="percent_spend_y_more_than_z_get_x_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\PercentBySpendAndGetStrategy</item>
                <item name="percent_buy_y_get_x_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\PercentByBuyAndGetStrategy</item>
                <item name="percent_buy_y_more_than_z_get_x_action" xsi:type="string">MageWorx\RewardPoints\Model\Rule\CalculationStrategy\PercentByBuyAndGetStrategy</item>
            </argument>
        </arguments>
    </type>

    <!-- Point Transaction Grid  -->
    <type name="Magento\Framework\View\Element\UiComponent\DataProvider\CollectionFactory">
        <arguments>
            <argument name="collections" xsi:type="array">
                <item name="mageworx_rewardpoints_transaction_listing_data_source" xsi:type="string">MageWorx\RewardPoints\Model\ResourceModel\PointTransaction\UiGrid\Collection</item>
            </argument>
        </arguments>
    </type>
    <type name="MageWorx\RewardPoints\Model\ResourceModel\PointTransaction\UiGrid\Collection">
        <arguments>
            <argument name="mainTable" xsi:type="string">mageworx_rewardpoints_transaction</argument>
            <argument name="eventPrefix" xsi:type="string">mageworx_rewardpoints_transaction_grid_collection</argument>
            <argument name="eventObject" xsi:type="string">transaction_grid_collection</argument>
            <argument name="resourceModel" xsi:type="string">MageWorx\RewardPoints\Model\ResourceModel\PointTransaction</argument>
        </arguments>
    </type>

    <!-- Reward Rule Grid  -->
    <type name="Magento\Framework\View\Element\UiComponent\DataProvider\CollectionFactory">
        <arguments>
            <argument name="collections" xsi:type="array">
                <item name="mageworx_rewardpoints_rule_listing_data_source" xsi:type="string">MageWorx\RewardPoints\Model\ResourceModel\Rule\Quote\Collection</item>
            </argument>
        </arguments>
    </type>
    <type name="MageWorx\RewardPoints\Model\ResourceModel\Rule\Quote\Collection">
        <arguments>
            <argument name="mainTable" xsi:type="string">mageworx_rewardpoints_rule</argument>
            <argument name="eventPrefix" xsi:type="string">mageworx_rewardpoints_rule_grid_collection</argument>
            <argument name="eventObject" xsi:type="string">rule_grid_collection</argument>
            <argument name="resourceModel" xsi:type="string">MageWorx\RewardPoints\Model\ResourceModel\Rule</argument>
        </arguments>
    </type>

    <virtualType name="MageWorxRewardpointsGridFilterPool" type="Magento\Framework\View\Element\UiComponent\DataProvider\FilterPool">
        <arguments>
            <argument name="appliers" xsi:type="array">
                <item name="regular" xsi:type="object">Magento\Framework\View\Element\UiComponent\DataProvider\RegularFilter</item>
                <item name="fulltext" xsi:type="object">Magento\Framework\View\Element\UiComponent\DataProvider\FulltextFilter</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Reward Rule Entity -->
    <type name="Magento\Framework\Model\Entity\RepositoryFactory">
        <arguments>
            <argument name="entities" xsi:type="array">
                <item name="MageWorx\RewardPoints\Api\Data\RuleInterface" xsi:type="string">MageWorx\RewardPoints\Model\ResourceModel\Rule</item>
            </argument>
        </arguments>
    </type>
    <type name="Magento\Framework\EntityManager\MetadataPool">
        <arguments>
            <argument name="metadata" xsi:type="array">
                <item name="MageWorx\RewardPoints\Api\Data\RuleInterface" xsi:type="array">
                    <item name="entityTableName" xsi:type="string">mageworx_rewardpoints_rule</item>
                    <item name="identifierField" xsi:type="string">rule_id</item>
                </item>
            </argument>
        </arguments>
    </type>
    <type name="Magento\Framework\EntityManager\Operation\AttributePool">
        <arguments>
            <argument name="extensionActions" xsi:type="array">
                <item name="mageworxRewardRule" xsi:type="array">
                    <item name="MageWorx\RewardPoints\Api\Data\RuleInterface" xsi:type="array">
                        <item name="read" xsi:type="string">MageWorx\RewardPoints\Model\ResourceModel\ReadHandler</item>
                        <item name="create" xsi:type="string">MageWorx\RewardPoints\Model\ResourceModel\SaveHandler</item>
                        <item name="update" xsi:type="string">MageWorx\RewardPoints\Model\ResourceModel\SaveHandler</item>
                    </item>
                </item>
            </argument>
        </arguments>
    </type>

    <type name="Magento\Framework\EntityManager\HydratorPool">
        <arguments>
            <argument name="hydrators" xsi:type="array">
                <item name="MageWorx\RewardPoints\Api\Data\RuleInterface" xsi:type="string">Magento\Framework\EntityManager\AbstractModelHydrator</item>
            </argument>
        </arguments>
    </type>

    <type name="Magento\Framework\EntityManager\TypeResolver">
        <plugin name="mageworx_rewardpoints_rule_typeresolver_workaround"
                type="MageWorx\RewardPoints\Model\Plugin\TypeResolverPlugin"
        />
    </type>

    <!-- Form -->
    <type name="MageWorx\RewardPoints\Model\Rule\Condition\Address">
        <arguments>
            <argument name="data" xsi:type="array">
                <item name="form_name" xsi:type="string">mageworx_rewardpoints_rule_form</item>
            </argument>
        </arguments>
    </type>
    <type name="MageWorx\RewardPoints\Model\Rule\Condition\Combine">
        <arguments>
            <argument name="data" xsi:type="array">
                <item name="form_name" xsi:type="string">mageworx_rewardpoints_rule_form</item>
            </argument>
        </arguments>
    </type>
    <type name="MageWorx\RewardPoints\Model\Rule\Condition\Product">
        <arguments>
            <argument name="data" xsi:type="array">
                <item name="form_name" xsi:type="string">mageworx_rewardpoints_rule_form</item>
            </argument>
        </arguments>
    </type>
    <type name="MageWorx\RewardPoints\Model\Rule\Condition\Product\Combine">
        <arguments>
            <argument name="data" xsi:type="array">
                <item name="form_name" xsi:type="string">mageworx_rewardpoints_rule_form</item>
            </argument>
        </arguments>
    </type>
    <type name="MageWorx\RewardPoints\Model\Rule\Condition\Product\Found">
        <arguments>
            <argument name="data" xsi:type="array">
                <item name="form_name" xsi:type="string">mageworx_rewardpoints_rule_form</item>
            </argument>
        </arguments>
    </type>
    <type name="MageWorx\RewardPoints\Model\Rule\Condition\Product\Subselect">
        <arguments>
            <argument name="data" xsi:type="array">
                <item name="form_name" xsi:type="string">mageworx_rewardpoints_rule_form</item>
            </argument>
        </arguments>
    </type>
    <type name="MageWorx\RewardPoints\Model\ResourceModel\Rule\AssociatedEntityMap">
        <arguments>
            <argument name="data" xsi:type="array">
                <item name="website" xsi:type="array">
                    <item name="associations_table" xsi:type="string">mageworx_rewardpoints_rule_website</item>
                    <item name="rule_id_field" xsi:type="string">rule_id</item>
                    <item name="entity_id_field" xsi:type="string">website_id</item>
                </item>
                <item name="customer_group" xsi:type="array">
                    <item name="associations_table" xsi:type="string">mageworx_rewardpoints_rule_customer_group</item>
                    <item name="rule_id_field" xsi:type="string">rule_id</item>
                    <item name="entity_id_field" xsi:type="string">customer_group_id</item>
                </item>
            </argument>
        </arguments>
    </type>

    <!-- Rss -->
    <type name="Magento\Framework\App\Rss\RssManagerInterface">
        <arguments>
            <argument name="dataProviders" xsi:type="array">
                <item name="mageworx_rewardpoints" xsi:type="string">MageWorx\RewardPoints\Block\Rss\RewardPoints</item>
            </argument>
        </arguments>
    </type>

    <!-- Rewardpoints attributes transfer from Quote to Total  -->
    <type name="Magento\Quote\Api\CartTotalRepositoryInterface">
        <plugin name="mageworx_rewardpoints_total_conversion" type="MageWorx\RewardPoints\Model\Plugin\TransferPointsDataFromQuoteToTotalPlugin" />
    </type>

    <type name="Magento\Quote\Model\Quote\TotalsCollector">
        <plugin name="mageworx_rewardpoints_reset_points_data_before_collect" type="MageWorx\RewardPoints\Model\Plugin\ResetPointsDataBeforeCollectPlugin" />
    </type>

    <type name="Magento\Sales\Model\Spi\CreditmemoResourceInterface">
        <plugin name="mageworx_rewardpoints_increase_points_refund" type="MageWorx\RewardPoints\Model\Plugin\IncreasePointsByRefundPlugin"/>
        <plugin name="mageworx_rewardpoints_decrease_points_refund" type="MageWorx\RewardPoints\Model\Plugin\DecreasePointsByRefundPlugin"/>
    </type>

    <type name="MageWorx\RewardPoints\Controller\Checkout\Apply">
        <arguments>
            <argument name="serializer" xsi:type="object">Magento\Framework\Serialize\Serializer\Json</argument>
        </arguments>
    </type>
    <type name="MageWorx\RewardPoints\Controller\Checkout\Cancel">
        <arguments>
            <argument name="serializer" xsi:type="object">Magento\Framework\Serialize\Serializer\Json</argument>
        </arguments>
    </type>

    <!-- Klarna: add reward points as order line item (type: discount) -->
    <type name="Klarna\Orderlines\Model\Container\Parameter">
        <arguments>
            <argument name="entities" xsi:type="array">
                <item name="mageworx_reward_points" xsi:type="object">MageWorx\RewardPoints\Model\Klarna\OrderLines\RewardPoints\Handler</item>
            </argument>
        </arguments>
    </type>
</config>
